#!/usr/bin/env bash
set -euo pipefail

# Auto theme switcher: select a theme, render, link, and reload components
# Usage: switch-theme.sh [theme]

# Resolve directories\script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
base_dir="$script_dir/.."
themes_dir="$base_dir/themes"
scripts_dir="$script_dir"
dotfiles_dir="$base_dir/dotfiles"

# Scan themes
mapfile -t themes < <(find "$themes_dir" -maxdepth 1 -mindepth 1 -type d -printf "%f\n" | sort)
if [[ ${#themes[@]} -eq 0 ]]; then
  echo "âŒ No themes found in $themes_dir"
  exit 1
fi

# Determine selected theme
if [[ $# -ge 1 ]]; then
  THEME="$1"
  if [[ ! -d "$themes_dir/$THEME" ]]; then
    echo "âŒ Unknown theme: $THEME"
    exit 1
  fi
else
  echo "Available themes:"
  for i in "${!themes[@]}"; do
    printf "%3d) %s\n" "$((i+1))" "${themes[i]}"
  done
  while true; do
    read -p "Select theme [1-${#themes[@]}]: " choice
    if [[ "$choice" =~ ^[0-9]+$ ]] && (( choice>=1 && choice<=${#themes[@]} )); then
      THEME="${themes[choice-1]}"
      break
    fi
    echo "Invalid selection."
  done
fi

echo "ðŸŒˆ Switching to theme: $THEME"

# 1) Render templates
"$scripts_dir/render-dotfiles.sh" "$THEME"

# 2) Link dotfiles
"$scripts_dir/link-dotfiles.sh"

# 3) Reload Hyprland
echo "ðŸ”„ Reloading Hyprland..."
hyprctl reload || echo "âš ï¸  hyprctl not found or failed"

# 4) Restart Waybar
echo "ðŸ›‘ Restarting Waybar..."
if pgrep -x waybar &>/dev/null; then
  killall waybar
  sleep 0.5
fi
waybar & disown

# 5) Reload Mako (notifications)
echo "ðŸ”” Reloading Mako..."
if pgrep -x mako &>/dev/null; then
  killall -SIGUSR1 mako
fi

echo "âœ… Theme switched to $THEME."

